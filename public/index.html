<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: #2d2d2d;
            border-bottom: 1px solid #3e3e3e;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
        }
        .header h1 {
            font-size: 18px;
            color: #4fc1ff;
        }
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .btn {
            background: #3e3e3e;
            border: 1px solid #555;
            color: #d4d4d4;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn:hover { background: #4e4e4e; }
        .btn-primary {
            background: #007acc;
            border-color: #005a9e;
        }
        .btn-primary:hover { background: #0086e6; }
        .tabs-container {
            background: #252526;
            border-bottom: 1px solid #3e3e3e;
            display: flex;
            align-items: center;
            padding: 0 10px;
            min-height: 35px;
            overflow-x: auto;
        }
        .tab {
            background: transparent;
            border: none;
            color: #969696;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .tab:hover { background: #2d2d2d; color: #d4d4d4; }
        .tab.active {
            color: #ffffff;
            border-bottom-color: #007acc;
            background: #1e1e1e;
        }
        .tab-close {
            opacity: 0;
            font-size: 14px;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
        }
        .tab:hover .tab-close { opacity: 1; }
        .tab-close:hover { background: #4e4e4e; }
        .terminal-container {
            flex: 1;
            background: #1e1e1e;
            padding: 10px;
            overflow: hidden;
        }
        #terminal { width: 100%; height: 100%; }
        .status-bar {
            background: #007acc;
            padding: 3px 10px;
            font-size: 12px;
            color: white;
            display: flex;
            justify-content: space-between;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
</head>
<body>
    <div class="header">
        <h1>Web Terminal</h1>
        <div class="header-controls">
            <span id="connectionStatus">Connected</span>
            <button class="btn btn-primary" onclick="createNewTerminal()">+ New Terminal</button>
        </div>
    </div>
    <div class="tabs-container" id="tabsContainer"></div>
    <div class="terminal-container">
        <div id="terminal"></div>
    </div>
    <div class="status-bar">
        <span id="terminalInfo">Ready</span>
        <span id="dimensions">80x24</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentTermId = null;
        let terminal = null;
        let fitAddon = null;

        function initTerminal() {
            terminal = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'monospace',
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4',
                    cursor: '#d4d4d4'
                }
            });
            fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);
            terminal.open(document.getElementById('terminal'));
            fitAddon.fit();

            terminal.onData((data) => {
                if (currentTermId) {
                    socket.emit('terminal-input', { termId: currentTermId, input: data });
                }
            });

            setTimeout(() => {
                fitAddon.fit();
                const { cols, rows } = terminal;
                document.getElementById('dimensions').textContent = cols + 'x' + rows;
                if (currentTermId) {
                    socket.emit('terminal-resize', { termId: currentTermId, cols, rows });
                }
            }, 100);
        }

        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').style.color = '#4fc1ff';
        });

        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').style.color = '#f14c4c';
        });

        socket.on('terminal-created', (data) => {
            const { termId, isInitial } = data;
            createTab(termId);
            if (isInitial && !terminal) initTerminal();
        });

        socket.on('terminal-output', (data) => {
            const { termId, data: output } = data;
            if (termId === currentTermId && terminal) {
                terminal.write(output);
            }
        });

        socket.on('terminal-closed', (data) => {
            const { termId } = data;
            removeTab(termId);
        });

        function createTab(termId) {
            const container = document.getElementById('tabsContainer');
            const tab = document.createElement('button');
            tab.className = 'tab';
            tab.id = 'tab-' + termId;
            tab.innerHTML = '<span>Term ' + termId.split('_')[1] + '</span><span class="tab-close" onclick="closeTerminal(\'' + termId + '\', event)">âœ•</span>';
            tab.onclick = () => switchTab(termId);
            container.appendChild(tab);

            const tabs = container.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentTermId = termId;
        }

        function switchTab(termId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + termId).classList.add('active');
            currentTermId = termId;
            socket.emit('switch-terminal', { termId });
        }

        function createNewTerminal() {
            socket.emit('create-terminal', {});
        }

        function closeTerminal(termId, event) {
            event.stopPropagation();
            socket.emit('close-terminal', { termId });
            removeTab(termId);
        }

        function removeTab(termId) {
            const tab = document.getElementById('tab-' + termId);
            if (tab) tab.remove();

            if (currentTermId === termId) {
                const remaining = document.querySelectorAll('.tab');
                if (remaining.length > 0) {
                    const newTermId = remaining[0].id.replace('tab-', '');
                    switchTab(newTermId);
                } else {
                    currentTermId = null;
                    if (terminal) terminal.clear();
                }
            }
        }

        window.addEventListener('resize', () => {
            if (fitAddon) {
                fitAddon.fit();
                const { cols, rows } = terminal;
                document.getElementById('dimensions').textContent = cols + 'x' + rows;
                if (currentTermId) {
                    socket.emit('terminal-resize', { termId: currentTermId, cols, rows });
                }
            }
        });
    </script>
</body>
</html>
